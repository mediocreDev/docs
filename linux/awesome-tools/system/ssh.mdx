---
title: "ssh"
description: "SSH personal notes."
---

#### SSH via private keys

```shell
# Generate key pair (anywhere/at client)
ssh-keygen -t ed25519 -C "comment (email/action...)"

# Validate by ssh to host using private key file
ssh -i $PRIVATE_KEY_PATH $USER@$HOST -p $PORT

# View public key (for copying)
cat ~/.ssh/id_ed25519.pub
# Windows
type $env:USERPROFILE\.ssh\id_ed25519.pub
# Initialize .ssh folder
mkdir -p ~/.ssh
# Copy
echo "PASTE YOUR PUBLIC KEY HERE" >> ~/.ssh/authorized_keys
# Set permission (just in case)
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# One-liner - Add public key to the authorized_keys of host's user, create path if not exist (process at client)
cat $PUBLIC_KEY_PATH | ssh $USER@$HOST -p $PORT "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

#### Change SSH port

- Prerequisites:

```shell
# Check ssh status
which sshd
# Install sshd
sudo systemctl status ssh
# Install
sudo apt update && sudo apt install openssh-server -y
```

- Modified `sshd_config`

```bash
# Find/Check location
find / -name "sshd_config" 2>/dev/null
# Edit
sudo vi /etc/ssh/sshd_config
```

- Search & uncomment `Port 22`, then change to the desired port.
- Restart `ssh` service

```shell
# Ubuntu
# Disable ssh.socket
sudo systemctl disable --now ssh.socket
sudo systemctl enable --now ssh.service
#sudo service ssh restart
sudo systemctl restart ssh

# AlmaLinux
systemctl restart sshd
```

- Allow port via [[ufw]]
- Setup script:

<CodeGroup>

```shell ubuntu.sh
#!/usr/bin/env bash
set -e

# ==== CONFIG ====
NEW_PORT=1993                # change this to your desired port
SSH_CONFIG="/etc/ssh/sshd_config"

echo "ðŸ” Checking sshd..."
if ! command -v sshd >/dev/null 2>&1; then
  echo "âš ï¸  OpenSSH server not found, installing..."
  sudo apt update && sudo apt install -y openssh-server
else
  echo "âœ… sshd found: $(which sshd)"
fi

echo "ðŸ§± Checking for socket-activation mode..."
if systemctl is-active --quiet ssh.socket; then
  echo "âš™ï¸  Disabling socket activation (so custom port works)..."
  sudo systemctl disable --now ssh.socket
  sudo systemctl enable --now ssh.service
else
  echo "âœ… Socket activation not in use or already disabled."
fi

echo "ðŸ“ Backing up sshd_config..."
sudo cp "$SSH_CONFIG" "${SSH_CONFIG}.bak.$(date +%F_%T)"

echo "âœï¸  Updating SSH port and disabling root login..."
sudo sed -i "s/^#Port .*/Port $NEW_PORT/" "$SSH_CONFIG"
sudo sed -i "s/^Port .*/Port $NEW_PORT/" "$SSH_CONFIG"
sudo sed -i "s/^#PermitRootLogin.*/PermitRootLogin no/" "$SSH_CONFIG"
sudo sed -i "s/^PermitRootLogin.*/PermitRootLogin no/" "$SSH_CONFIG"

echo "ðŸ” Validating sshd configuration..."
sudo sshd -t && echo "âœ… sshd configuration OK"

echo "ðŸ§± Adjusting firewall rules..."
sudo ufw allow $NEW_PORT/tcp || true
sudo ufw allow 22/tcp || true     # keep old port open for safety

echo "ðŸ” Restarting SSH service..."
sudo systemctl restart ssh

echo "ðŸ”Ž Checking new port..."
if sudo ss -tuln | grep ":$NEW_PORT" >/dev/null; then
  echo "âœ… SSH is now listening on port $NEW_PORT"
else
  echo "âš ï¸  SSH not yet listening on $NEW_PORT â€” check /etc/ssh/sshd_config"
fi

SERVER_IP=$(hostname -I | awk '{print $1}')
echo ""
echo "ðŸ§ª Test new connection in another terminal:"
echo "    ssh -p $NEW_PORT $(whoami)@$SERVER_IP"
echo ""
echo "âš ï¸  Keep this session open until you confirm new access works!"
echo ""

read -p "Press Enter once you successfully connect via new port..."

echo "ðŸš« Removing old port 22 from firewall..."
sudo ufw delete allow 22/tcp || true

echo "ðŸ›¡ï¸ Installing Fail2Ban (optional but recommended)..."
sudo apt install -y fail2ban

echo ""
echo "âœ… Done! SSH hardened and running on port $NEW_PORT"
echo "   â€¢ Root login disabled"
echo "   â€¢ Fail2Ban active"
echo "   â€¢ Socket activation off (using ssh.service)"
```


```shell almalinux.sh
#!/bin/bash

# === CONFIGURABLE SETTINGS ===
NEW_PORT=1993                 # change if you want a different SSH port
DISABLE_PASSWORD_AUTH=false   # set to false if you want to keep password login
DISABLE_ROOT_LOGIN=true       # disable direct root login
SSHD_CONFIG="/etc/ssh/sshd_config"

echo "ðŸ“¦ Updating system"
sudo dnf -y update

echo "ðŸ“¦ Installing firewalld and fail2ban"
sudo dnf -y install firewalld fail2ban

echo "ðŸ“¦ Installing semanage, just in case"
sudo dnf install policycoreutils-python-utils

echo "âš¡ Enabling firewalld"
sudo systemctl enable --now firewalld

echo "âš™ï¸ Configuring firewall rules"
sudo firewall-cmd --permanent --add-service=ssh   # keep existing port open for now
sudo firewall-cmd --permanent --add-port=${NEW_PORT}/tcp
sudo firewall-cmd --reload

echo "âœï¸ Editing SSH config - change port"
sudo sed -i "s/^#Port.*/Port ${NEW_PORT}/" $SSHD_CONFIG
sudo sed -i "s/^Port .*/Port ${NEW_PORT}/" $SSHD_CONFIG

#echo "âœï¸ Editing SSH config - disable root login"
#if [ "$DISABLE_ROOT_LOGIN" = true ]; then
#    sudo sed -i "s/^#PermitRootLogin.*/PermitRootLogin no/" $SSHD_CONFIG
#    sudo sed -i "s/^PermitRootLogin.*/PermitRootLogin no/" $SSHD_CONFIG
#fi

#echo "âœï¸ Editing SSH config - disable authentication via password"
#if [ "$DISABLE_PASSWORD_AUTH" = true ]; then
#    sudo sed -i "s/^#PasswordAuthentication.*/PasswordAuthentication no/" $SSHD_CONFIG
#    sudo sed -i "s/^PasswordAuthentication.*/PasswordAuthentication no/" $SSHD_CONFIG
#fi

echo "âš™ï¸ Configuring SELinux SSH port permission"
if [ "$(getenforce)" = "Enforcing" ]; then
    sudo semanage port -a -t ssh_port_t -p tcp "$NEW_SSH_PORT"
else
    echo "SELinux is not Enforcing (it is Disabled or Permissive). No semanage action needed."
fi

echo "ðŸ”„ Restarting SSH"
sudo systemctl restart sshd

echo "âš™ï¸ Configuring Fail2Ban"
sudo bash -c 'cat > /etc/fail2ban/jail.local' <<EOF
[sshd]
enabled = true
port = ${NEW_PORT}
logpath = /var/log/secure
maxretry = 5
bantime = 10m
EOF

echo "âš¡ Enabling Fail2Ban"
sudo systemctl enable --now fail2ban

echo "ðŸŽ¯ HARDENING SSH COMPLETED"
echo "IMPORTANT: Open a new terminal and test logging into SSH on port ${NEW_PORT} before closing this session!"
```

</CodeGroup>