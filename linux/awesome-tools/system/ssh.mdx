---
title: "ssh"
description: "SSH personal notes."
---

#### SSH via private keys

```shell
# Generate key pair (anywhere/at client)
ssh-keygen -t ed25519 -C "comment (email/action...)"

# Validate by ssh to host using private key file
ssh -i $PRIVATE_KEY_PATH $USER@$HOST -p $PORT

# View public key (for copying)
cat ~/.ssh/id_ed25519.pub
# Windows
type $env:USERPROFILE\.ssh\id_ed25519.pub
# Initialize .ssh folder
mkdir -p ~/.ssh
# Copy
echo "PASTE YOUR PUBLIC KEY HERE" >> ~/.ssh/authorized_keys
# Set permission (just in case)
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# One-liner - Add public key to the authorized_keys of host's user, create path if not exist (process at client)
cat $PUBLIC_KEY_PATH | ssh $USER@$HOST -p $PORT "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

#### Change SSH port

- Prerequisites:

```shell
# Check ssh status
which sshd
# Install sshd
sudo systemctl status ssh
# Install
sudo apt update && sudo apt install openssh-server -y
```

- Modified `sshd_config`

```bash
# Find/Check location
find / -name "sshd_config" 2>/dev/null
# Edit
sudo vi /etc/ssh/sshd_config
```

- Search & uncomment `Port 22`, then change to the desired port.
- Restart `ssh` service

```shell
# Ubuntu
# Disable ssh.socket
sudo systemctl disable --now ssh.socket
sudo systemctl enable --now ssh.service
#sudo service ssh restart
sudo systemctl restart ssh

# AlmaLinux
systemctl restart sshd
```

- Allow port via [[ufw]]/[firewalld]
- Apply fail2ban

#### Setup script:

<CodeGroup>

```shell ubuntu.sh expandable
#!/usr/bin/env bash
set -e

### ===== CUSTOM OPTIONS =====
CUSTOM_PORT=2222
ALLOW_PASSWORD_LOGIN=true

NEWUSER="americio"
SSH_PUBLIC_KEY="ssh-ed25519 AAAA...your_key_here"
PASSWORDLESS_SUDO=false

BANTIME="1h"
FINDTIME="10m"
MAXRETRY=3
### ===========================

FILE=/etc/ssh/sshd_config

echo "ðŸ’¾ Backing up original sshd_config"
sudo cp "$FILE" "$FILE.backup.$(date +%F-%H%M%S)"

echo "âœ’ï¸ Writing secure sshd_config..."

sudo tee "$FILE" >/dev/null <<EOF
# ===== SECURE SSH CONFIG (FRESH VPS) =====

# Port (change from default 22 reduces random bots)
Port ${CUSTOM_PORT}
# To disable IPv6 for SSH, uncomment:
# AddressFamily inet

# Authentication
PermitRootLogin no
PasswordAuthentication $( [ "$ALLOW_PASSWORD_LOGIN" = true ] && echo "yes" || echo "no" )
PermitEmptyPasswords no
KbdInteractiveAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# Security limits
MaxAuthTries 3
LoginGraceTime 20
MaxSessions 2

# Keepalive
ClientAliveInterval 120
ClientAliveCountMax 2

# Logging
LogLevel VERBOSE

# Default "Include" directory
Include /etc/ssh/sshd_config.d/*.conf
EOF

echo "ðŸ¤” Validating new SSH configuration..."
if sudo sshd -t; then
    echo "âœ… SSH config OK. Reloading sshd..."
    sudo systemctl reload sshd
    echo "ðŸ‘Œ SSH hardened successfully."
else
    echo "â›” SSH config ERROR. Restoring backup..."
    sudo cp "$FILE.backup"* "$FILE"
    exit 1
fi

echo "===================================================================="

echo "ðŸª„ Creating user: $NEWUSER"
if id "$NEWUSER" >/dev/null 2>&1; then
    echo "ðŸ‘» User already exists, skipping."
else
    sudo adduser --disabled-password --gecos "" "$NEWUSER"
	GENPASS=$(openssl rand -base64 16)
	echo "$NEWUSER:$GENPASS" | sudo chpasswd
	echo "ðŸ” Temporary password for $NEWUSER: $GENPASS"
fi

echo "ðŸ¤ Adding $NEWUSER to sudo group"
sudo usermod -aG sudo "$NEWUSER"
sudo usermod -aG adm "$NEWUSER"
sudo usermod -s /bin/bash "$NEWUSER"

echo "ðŸ—ƒï¸ Setting up SSH directory"
sudo mkdir -p /home/$NEWUSER/.ssh
echo "$SSH_PUBLIC_KEY" | sudo tee /home/$NEWUSER/.ssh/authorized_keys >/dev/null

sudo chmod 700 /home/$NEWUSER/.ssh
sudo chmod 600 /home/$NEWUSER/.ssh/authorized_keys
sudo chown -R $NEWUSER:$NEWUSER /home/$NEWUSER/.ssh

if [ "$PASSWORDLESS_SUDO" = true ]; then
    echo "ðŸ”“ Enabling passwordless sudo for $NEWUSER"
    echo "$NEWUSER ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/90-$NEWUSER >/dev/null
    sudo chmod 440 /etc/sudoers.d/90-$NEWUSER
fi

echo "ðŸ”’ Locking root password (optional safety)"
sudo passwd -l root

echo "ðŸ‘Œ Secure sudo user setup completed."
echo "Now log in as: ssh $NEWUSER@your-server -p $CUSTOM_PORT"

echo "===================================================================="

echo "ðŸ›¡ï¸ Configuring UFW firewall with safe defaults"

sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing

echo "ðŸ”“ Allowing SSH port: $CUSTOM_PORT and other common ports (http, https)"
sudo ufw limit ${CUSTOM_PORT}/tcp
sudo ufw allow http
sudo ufw allow https

echo "ðŸš€ Enabling firewall..."
sudo ufw --force enable

echo "ðŸ“‹ UFW status:"
sudo ufw status verbose

echo "ðŸ‘Œ UFW firewall configuration completed."

echo "===================================================================="

echo "ðŸ“¦ Installing fail2ban..."
sudo apt update
sudo apt install -y fail2ban

JAIL_LOCAL="/etc/fail2ban/jail.local"

echo "ðŸ“ Writing fail2ban jail.local..."
sudo tee $JAIL_LOCAL >/dev/null <<EOF
[DEFAULT]
bantime = ${BANTIME}
findtime = ${FINDTIME}
maxretry = ${MAXRETRY}
backend = systemd
banaction = ufw
ignoreip = 127.0.0.1/8 ::1

[sshd]
enabled = true
port = ${CUSTOM_PORT}
filter = sshd
backend = systemd
logpath = journal
EOF

echo "ðŸ”„ Restarting Fail2ban..."
sudo systemctl restart fail2ban

echo "ðŸ” Fail2ban SSH jail status:"
sudo fail2ban-client status sshd

echo "ðŸ‘Œ Fail2ban installed & configured."

echo "===================================================================="

echo "ðŸ“¦ Unattended Security Updates (auto-patch for critical CVEs)"
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

if false; then
	
	echo "===================================================================="
	echo "ðŸ” Enabling SSH 2FA (TOTP via Google Authenticator)"

	echo "ðŸ“¦ Installing TOTP PAM module..."
	sudo apt install -y libpam-google-authenticator

	echo "ðŸªª Generating TOTP secret for user: $NEWUSER"
	sudo -u "$NEWUSER" bash -c "google-authenticator -t -d -f -r 3 -R 30 -W --quiet"

	echo "ðŸ“ Backing up SSH PAM config..."
	sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.bak.$(date +%F-%H%M%S)

	echo "âœ’ï¸ Updating PAM rules for TOTP"
	sudo sed -i '1i auth required pam_google_authenticator.so' /etc/pam.d/sshd

	echo "ðŸ“ Backing up sshd_config..."
	sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F-%H%M%S)

	echo "âš™ï¸ Configuring SSH to require BOTH publickey & TOTP"
	sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication yes/' /etc/ssh/sshd_config
	sudo sed -i 's/^#\?KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config

	# Require BOTH:
	# - publickey
	# - keyboard-interactive (Google Authenticator)
	if grep -q "^AuthenticationMethods" /etc/ssh/sshd_config; then
		sudo sed -i 's/^AuthenticationMethods.*/AuthenticationMethods publickey,keyboard-interactive/' /etc/ssh/sshd_config
	else
		echo "AuthenticationMethods publickey,keyboard-interactive" | sudo tee -a /etc/ssh/sshd_config >/dev/null
	fi

	echo "ðŸ¤” Validating SSH configuration with 2FA..."
	if sudo sshd -t; then
		echo "âœ… SSH config OK. Restarting sshd..."
		sudo systemctl restart sshd
		echo "ðŸ” SSH 2FA enabled successfully."
	else
		echo "â›” ERROR: Invalid SSH config. Rolling back..."
		sudo cp /etc/ssh/sshd_config.bak.* /etc/ssh/sshd_config
		sudo cp /etc/pam.d/sshd.bak.* /etc/pam.d/sshd
		sudo systemctl restart sshd
		exit 1
	fi

	echo "âœ¨ 2FA Setup Completed."
	echo "ðŸ‘‰ IMPORTANT: Open a NEW terminal and test login before closing this session."
	echo "SSH Login now requires:"
	echo "  1) SSH private key"
	echo "  2) Google Authenticator 6-digit TOTP code"
	
	echo "===================================================================="
	
	echo "ðŸ“œ Installing hardened auditd rules..."

	sudo tee /etc/audit/rules.d/hardening.rules >/dev/null << "EOF"
## ===============================
## HARDENED AUDITD SECURITY RULES
## ===============================

# Track all commands executed via sudo
-w /var/log/sudo.log -p wa -k sudo_logs

# Track changes to privileged binaries (SUID/SGID)
-w /usr/bin -p wa -k privileged-bins
-w /usr/sbin -p wa -k privileged-bins

# Track changes to essential system config
-w /etc/passwd -p wa -k passwd_changes
-w /etc/group -p wa -k group_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d/ -p wa -k sudoers_changes

# Track SSH configuration changes
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/ssh/sshd_config.d/ -p wa -k ssh_config

# Track all login/logout events, including failures
-w /var/log/faillog -p wa -k auth_failures
-w /var/log/lastlog -p wa -k auth_changes
-w /var/log/tallylog -p wa -k auth_failures

# Track modification to systemd service files
-w /etc/systemd/system/ -p wa -k systemd_changes
-w /usr/lib/systemd/system/ -p wa -k systemd_changes

# Track kernel module loading/unloading
-w /sbin/modprobe -p x -k kernel_modules
-w /usr/sbin/modprobe -p x -k kernel_modules

# Record attempts to become root
-w /bin/su -p x -k root_escalation

# Monitor unauthorized file permission or attribute changes
-a always,exit -F arch=b64 -S chmod,chown,chgrp,fchmod,fchown -k perms
-a always,exit -F arch=b32 -S chmod,chown,chgrp,fchmod,fchown -k perms

# Detect root-level shell spawning (/bin/bash executed by UID 0)
-a always,exit -F arch=b64 -S execve -F uid=0 -k root_shell
-a always,exit -F arch=b32 -S execve -F uid=0 -k root_shell

# Detect modifications to firewall rules
-w /etc/ufw/ -p wa -k ufw_changes
-w /etc/firewalld/ -p wa -k firewalld_changes

# Track crontab modifications (cron persistence attacks)
-w /etc/crontab -p wa -k cron_changes
-w /etc/cron.d/ -p wa -k cron_changes
-w /etc/cron.daily/ -p wa -k cron_changes
-w /etc/cron.hourly/ -p wa -k cron_changes

# Ensure audit configuration itself is immutable
-e 2
EOF
	echo "ðŸ”„ Reloading audit rules..."
	sudo augenrules --load
	sudo systemctl restart auditd

	echo "âœ… auditd hardening rules installed!"
fi
```


```shell almalinux.sh
#!/usr/bin/env bash
set -e

### ===== CUSTOM OPTIONS =====
CUSTOM_PORT=2222
ALLOW_PASSWORD_LOGIN=true

NEWUSER="americio"
SSH_PUBLIC_KEY="ssh-ed25519 AAAA...your_key_here"
PASSWORDLESS_SUDO=false

BANTIME="1h"
FINDTIME="10m"
MAXRETRY=3
### ===========================

FILE=/etc/ssh/sshd_config

echo "ðŸ’¾ Backing up original sshd_config"
sudo cp "$FILE" "$FILE.backup.$(date +%F-%H%M%S)"

echo "âœ’ï¸ Writing secure sshd_config..."
sudo tee "$FILE" >/dev/null <<EOF
Port ${CUSTOM_PORT}
PermitRootLogin no
PasswordAuthentication $( [ "$ALLOW_PASSWORD_LOGIN" = true ] && echo "yes" || echo "no" )
PermitEmptyPasswords no
PubkeyAuthentication yes
KbdInteractiveAuthentication no
AuthorizedKeysFile .ssh/authorized_keys
MaxAuthTries 3
LoginGraceTime 20
MaxSessions 2
ClientAliveInterval 120
ClientAliveCountMax 2
LogLevel VERBOSE
Include /etc/ssh/sshd_config.d/*.conf
EOF

echo "ðŸ¤” Validating SSH configuration..."
sudo sshd -t

echo "ðŸ”§ Adjusting SELinux for custom SSH port"
sudo dnf install -y policycoreutils-python-utils
sudo semanage port -a -t ssh_port_t -p tcp $CUSTOM_PORT 2>/dev/null || \
sudo semanage port -m -t ssh_port_t -p tcp $CUSTOM_PORT

echo "ðŸ”„ Restarting SSH daemon"
sudo systemctl restart sshd

echo "=============================================================="
echo "ðŸ§‘â€ðŸ’» Creating user: $NEWUSER"
if ! id "$NEWUSER" &>/dev/null; then
    sudo adduser "$NEWUSER"
    GENPASS=$(openssl rand -base64 16)
    echo "$NEWUSER:$GENPASS" | sudo chpasswd
    echo "Temporary password for $NEWUSER: $GENPASS"
fi

echo "ðŸ”‘ Installing SSH key for user"
sudo mkdir -p /home/$NEWUSER/.ssh
echo "$SSH_PUBLIC_KEY" | sudo tee /home/$NEWUSER/.ssh/authorized_keys >/dev/null
sudo chmod 700 /home/$NEWUSER/.ssh
sudo chmod 600 /home/$NEWUSER/.ssh/authorized_keys
sudo chown -R $NEWUSER:$NEWUSER /home/$NEWUSER/.ssh

echo "ðŸ¤ Adding to wheel group (sudo)"
sudo usermod -aG wheel $NEWUSER

if [ "$PASSWORDLESS_SUDO" = true ]; then
    echo "$NEWUSER ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$NEWUSER >/dev/null
fi

echo "=============================================================="
echo "ðŸ”¥ Configuring Firewalld"
sudo systemctl enable --now firewalld
sudo firewall-cmd --permanent --add-port=${CUSTOM_PORT}/tcp
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

echo "=============================================================="
echo "ðŸ“¦ Installing fail2ban"
sudo dnf install -y epel-release
sudo dnf install -y fail2ban

sudo tee /etc/fail2ban/jail.local >/dev/null <<EOF
[DEFAULT]
bantime = ${BANTIME}
findtime = ${FINDTIME}
maxretry = ${MAXRETRY}
backend = systemd

[sshd]
enabled = true
port = ${CUSTOM_PORT}
EOF

sudo systemctl enable --now fail2ban
sudo fail2ban-client status sshd

echo "=============================================================="
echo "ðŸ”„ Enabling automatic security updates"
sudo dnf install -y dnf-automatic
sudo systemctl enable --now dnf-automatic.timer

echo "=============================================================="
echo "ðŸ“Œ TODO: SSH banners / honeypot protection"
# - Add SSH banner (Banner /etc/issue.net)
# - Deploy Cowrie honeypot (docker or container)
# - Optional: fake SSH ports for decoy
# These are commented for reference and manual review

echo "=============================================================="
echo "ðŸ“Œ TODO: Disable password login 100%"
# - To fully enforce publickey-only:
#   PasswordAuthentication no
#   ChallengeResponseAuthentication no
#   Ensure PAM does not allow password fallback
# - Currently controlled by ALLOW_PASSWORD_LOGIN variable
# - Keep current session open and test login before enforcing

echo "=============================================================="
echo "ðŸ“Œ Reference block: Google Authenticator 2FA & auditd hardening"
if false; then
    echo "ðŸ” Installing Google Authenticator for TOTP 2FA"
    sudo dnf install -y libpam-google-authenticator
    sudo -u "$NEWUSER" google-authenticator -t -d -f -r 3 -R 30 -W --quiet
    sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.bak.$(date +%F-%H%M%S)
    echo "auth required pam_google_authenticator.so" | sudo tee -a /etc/pam.d/sshd
    sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication yes/' /etc/ssh/sshd_config
    sudo sed -i 's/^#\?KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
    if grep -q "^AuthenticationMethods" /etc/ssh/sshd_config; then
        sudo sed -i 's/^AuthenticationMethods.*/AuthenticationMethods publickey,keyboard-interactive/' /etc/ssh/sshd_config
    else
        echo "AuthenticationMethods publickey,keyboard-interactive" | sudo tee -a /etc/ssh/sshd_config >/dev/null
    fi
    sudo sshd -t
    sudo systemctl restart sshd
    echo "âœ… Google Authenticator 2FA enabled (reference)"
    
    echo "ðŸ“¦ Installing and hardening auditd"
    sudo dnf install -y audit
    sudo tee /etc/audit/rules.d/hardening.rules >/dev/null << 'EOF'
# track sudo/sudoers
-w /var/log/sudo.log -p wa -k sudo_logs
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d/ -p wa -k sudoers_changes
# track SSH config
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/ssh/sshd_config.d/ -p wa -k ssh_config
# privileged binaries
-w /usr/bin -p wa -k privileged-bins
-w /usr/sbin -p wa -k privileged-bins
# login/logout
-w /var/log/faillog -p wa -k auth_failures
-w /var/log/lastlog -p wa -k auth_changes
# kernel module loads
-w /sbin/modprobe -p x -k kernel_modules
# detect root shell spawn
-a always,exit -F arch=b64 -S execve -F uid=0 -k root_shell
# make audit config immutable
-e 2
EOF
    sudo augenrules --load
    sudo systemctl restart auditd
    echo "âœ… auditd hardening installed (reference)"
fi

echo "=============================================================="
echo "âœ¨ AlmaLinux SSH hardening script completed (reference-ready)"
echo "Login using: ssh $NEWUSER@server -p $CUSTOM_PORT"
echo "Keep your existing SSH session open while testing."
```

</CodeGroup>

- Run:

```shell
curl -O https://gist.githubusercontent.com/username/abcdef1234567890/raw/harden.sh
chmod +x ./harden.sh
sudo ./harden.sh
# One-liner, no download
curl -sSL https://gist.githubusercontent.com/username/abcdef1234567890/raw/harden.sh | sudo bash
```